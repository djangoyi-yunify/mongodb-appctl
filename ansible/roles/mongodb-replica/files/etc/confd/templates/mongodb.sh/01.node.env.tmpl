{{- $nodeRole := getv "/host/role" }}

tmpstr={{ getv "/env/conf.net.port" }}
flush > /opt/app/current/bin/envs/node.env << NODE_ENV_FILE
NODE_CTL=nodectl
MY_SID={{ getv "/host/sid" }}
MY_IP={{ getv "/host/ip" }}
MY_ROLE={{ $nodeRole }}
GLOBAL_UUID={{ getv "/cluster/global_uuid" }}
CLUSTER_ID={{ getv "/cluster/cluster_id" }}
DATA_MOUNTS="/data"
CONF_NET_PORT=$tmpstr
SERVICES="mongod/true/tcp:$tmpstr"
CONF_MAINTAIN_NET_PORT=27099
QC_USER=qc_master

{{- if len (ls "/vertical-scaling-roles") }}
VERTICAL_SCALING_FLAG=true
{{- else }}
VERTICAL_SCALING_FLAG=false
{{- end }}

{{- if len (ls "/change-vxnet-audit") }}
CHANGE_VXNET_FLAG=true
{{- else }}
CHANGE_VXNET_FLAG=false
{{- end }}

{{- if len (ls "/adding-hosts") }}
ADDING_HOSTS_FLAG=true
{{- else }}
ADDING_HOSTS_FLAG=false
{{- end }}

{{- if eq $nodeRole "repl_node" }}
NODE_LIST=(
    {{- range $dir := lsdir "/hosts/repl_node" -}}
    {{- $sid := printf "/hosts/repl_node/%s/sid" $dir -}}
    {{- $ip := printf "/hosts/repl_node/%s/ip" $dir -}}
    {{- $node_id := printf "/hosts/repl_node/%s/node_id" $dir -}}
    '{{getv $sid}}|{{getv $ip}}|{{getv $node_id}}' {{print}}
    {{- end -}})
{{- else }}
NODE_LIST=(
    {{- range $dir := lsdir "/hosts/ro_node" -}}
    {{- $sid := printf "/hosts/ro_node/%s/sid" $dir -}}
    {{- $ip := printf "/hosts/ro_node/%s/ip" $dir -}}
    {{- $node_id := printf "/hosts/ro_node/%s/node_id" $dir -}}
    '{{getv $sid}}|{{getv $ip}}|{{getv $node_id}}' {{print}}
    {{- end -}})
{{- end }}
NODE_ENV_FILE