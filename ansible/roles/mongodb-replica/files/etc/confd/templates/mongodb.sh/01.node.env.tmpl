{{- $nodeRole := getv "/host/role" }}

guid={{ getv "/cluster/global_uuid" }}
subfix=${guid:0:4}
tmpstr={{ getv "/env/conf.net.port" }}
flush > /opt/app/current/bin/envs/node.env << NODE_ENV_FILE
NODE_CTL=nodectl
MY_SID={{ getv "/host/sid" }}
MY_IP={{ getv "/host/ip" }}
MY_ROLE={{ $nodeRole }}
GLOBAL_UUID=$guid
CLUSTER_ID={{ getv "/cluster/cluster_id" }}
DATA_MOUNTS="/data"
CONF_NET_PORT=$tmpstr
SERVICES="mongod/true/tcp:$tmpstr"
CONF_MAINTAIN_NET_PORT=27099
DB_QC_USER=qc_master
DB_ROOT_USER=root
DB_ROOT_PWD={{ getv "/env/db.userpass" }}

RS_NAME=rs_$subfix
RS_RO_NAME=rs_ro_$subfix

{{- if len (ls "/vertical-scaling-roles") }}
VERTICAL_SCALING_FLAG=true
{{- else }}
VERTICAL_SCALING_FLAG=false
{{- end }}

{{- if len (ls "/change-vxnet-audit") }}
CHANGE_VXNET_FLAG=true
CHANGE_VXNET_ROLES='{{ getv "/change-vxnet-audit/roles" }}'
{{- else }}
CHANGE_VXNET_FLAG=false
{{- end }}

{{- if len (ls "/adding-hosts") }}
ADDING_HOSTS_FLAG=true
{{- else }}
ADDING_HOSTS_FLAG=false
{{- end }}

NODE_LIST=(
    {{- range $dir := lsdir "/hosts/repl_node" -}}
    {{- $sid := printf "/hosts/repl_node/%s/sid" $dir -}}
    {{- $ip := printf "/hosts/repl_node/%s/ip" $dir -}}
    {{- $node_id := printf "/hosts/repl_node/%s/node_id" $dir -}}
    '{{getv $sid}}|{{getv $ip}}|{{getv $node_id}}' {{print}}
    {{- end -}})

NODE_RO_LIST=(
    {{- range $dir := lsdir "/hosts/ro_node" -}}
    {{- $sid := printf "/hosts/ro_node/%s/sid" $dir -}}
    {{- $ip := printf "/hosts/ro_node/%s/ip" $dir -}}
    {{- $node_id := printf "/hosts/ro_node/%s/node_id" $dir -}}
    '{{getv $sid}}|{{getv $ip}}|{{getv $node_id}}' {{print}}
    {{- end -}})
NODE_ENV_FILE